#![Logo](gatherr.jpg "Our Logo")

# GATHeR: Graph-based Accurate Tool for immunoglobulin HEavy- and light-chain Reconstruction

This repository provides the environment setup for `gather`, including all necessary dependencies. Follow the instructions below to create and activate the environment using `conda`.

## Table of Contents

- [Prerequisites](#prerequisites)
- [Installation](#installation)
- [Usage](#usage)
- [Processing 10x Genomics Chromium Single-Cell RNA-Seq Data for Assembly](#processing-10x-genomics-chromium-single-cell-rna-seq-data-for-assembly)
- [Contributing](#contributing)
- [License](#license)

## Installation

### Quick Setup with Singularity (Recommended)

To simplify installation and ensure reproducibility, we provide a prebuilt Singularity image: `GATHER.sif`.

**Before you begin:**  
Ensure [Singularity](https://docs.sylabs.io/guides/latest/user-guide/) is installed on your system. You can check with:

```bash
singularity --version
```

Once verified, you can run the GATHeR tools directly from the image without any additional installation:

```bash
singularity exec GATHER.sif sc_asm.py --help
```

This method is ideal for high-performance computing clusters or environments where software installation is restricted. The `.sif` image contains all necessary dependencies for running GATHeR workflows.

### Manual Environment Setup (Conda-Based)

If you prefer a local development environment, you can manually install all dependencies using Conda.

#### Using the Environment File

1. **Clone the Repository**:

    ```bash
    git clone https://github.com/Neuroimmunology-UiO/gather.git
    cd gather
    ```

2. **Create the Environment**:

    ```bash
    conda env create -f environment.yml
    ```

3. **Activate the Environment**:

    ```bash
    conda activate gather-env
    ```

#### Installing Dependencies Manually

1. **Create and activate a Conda environment**:

    ```bash
    conda create --name gather-env python=3.8
    conda activate gather-env
    ```

2. **Install Python dependencies**:

    ```bash
    pip install -r requirements.txt
    ```

3. **Install `bcalm` via Bioconda**:

    ```bash
    conda install -c bioconda bcalm
    ```

---

Let me know what you'd like to add or revise next!

## Usage

GATHeR supports single-cell RNA sequencing data from technologies like Smart-seq2/3 and 10x Genomics Chromium.

### Merging Paired-End Reads

If your reads are paired-end:

```bash
cat {cell_file_name}_R1.fastq.gz {cell_file_name}_R2.fastq.gz > {cell_file_name}_merged.fastq.gz
```

Then run:

```bash
sc_asm.py --seq_merged {cell_file_name}_merged.fastq.gz --seq_1 {cell_file_name}_R1.fastq.gz --seq_2 {cell_file_name}_R2.fastq.gz
```

### Output Files

- `{cell_file_name}_merged.fastq.unitigs.fa`: Unitigs from the cDBG graph  
- `{cell_file_name}_merged.fastq.contigs.fa`: Assembled contigs (transcriptome, GATHeR algorithm)  
- `{cell_file_name}_merged.fastq.BCR.fa`: Annotated BCR sequences (GATHeR algorithm)
- `{cell_file_name}_merged.fastq.BCR_HE.fa`: Filtered BCR sequences based on the weight and contiguity (GATHeR algorithm)

### Single-End Data

```bash
sc_asm.py --seq_merged {cell_file_name}_R1.fastq.gz --seq_1 {cell_file_name}_R1.fastq.gz
```

### SPAdes Mode for Low Coverage or Naive/memory B Cells

Recommended for low read depth or naive B-cells:

```bash
sc_asm.py --seq_merged {cell_file_name}_merged.fastq.gz --seq_1 {cell_file_name}_R1.fastq.gz --seq_2 {cell_file_name}_R2.fastq.gz --min_freq 3 --use_spades
```

Additional outputs:

- `{cell_file_name}_merged.fastq.BCR_contigus.fa`: Annotated BCRs from SPAdes  
- `transcripts.fasta`: Assembled transcriptome (SPAdes algorithm)
- `{cell_file_name}_merged.fastq.BCR_HE.fa`: Filtered BCR sequences based on the weight and contiguity (SPAdes algorithm)

### K-mer Size

- Default: `k = 25`
- Rule of thumb: `k < read length - 20`
- For short reads (e.g., 30 bp), the feasible k-mer size range is constrained; values between 21 and 25 are generally appropriate, with 27 being a possible upper limit depending on the context.
- 
## Processing 10x Genomics Chromium Single-Cell RNA-Seq Data for Assembly

To assemble data generated by 10x Genomics Chromium single-cell RNA-seq, the raw sequencing reads must first be processed using Cell Ranger, which organizes the output files in the following structure:

```
project_folder/
├── fastq/
│   ├── sample_name_S1_L001_R1_001.fastq.gz  # Read 1: contains cell barcodes and UMIs
│   ├── sample_name_S1_L001_R2_001.fastq.gz  # Read 2: contains the cDNA read
│   └── sample_name_S1_L001_I1_001.fastq.gz  # Index read (optional; used for sample demultiplexing)
```

The list of detected cell barcodes is typically located in:

```
outs/filtered_feature_bc_matrix/barcodes.tsv.gz
```

### Prepare the Data for Assembly

1. Concatenate all R1 reads:

    ```bash
    cat *R1*.fastq.gz > Merged_R1.fastq.gz
    ```

2. Concatenate all R2 reads:

    ```bash
    cat *R2*.fastq.gz > Merged_R2.fastq.gz
    ```

3. Decompress the barcode file:

    ```bash
    gunzip barcodes.tsv.gz
    ```

4. Run the assembly script:

    ```bash
    10x_asm.py --barcode_file barcodes.tsv \
               --r1_fastq Merged_R1.fastq.gz \
               --r2_fastq Merged_R2.fastq.gz \
               --output_dir_name cells
    ```

**Note**: The `--num_jobs` parameter defaults to 8, but for optimal performance, set it to the maximum number of available CPU cores.

## Clonality analysis

After successfully assembling B-cell receptor sequences for each cell, the reconstructed heavy and light chains—each saved in separate FASTA files with identifiable headers—can be merged across all cells to perform clonality analysis.

### Step 1: Prepare IgBLAST and Reference Databases

To assign V(D)J genes and annotate the junctional regions, we rely on [IgBLAST](https://www.ncbi.nlm.nih.gov/igblast/) and reference data from the IMGT database. Setting up the IgBLAST environment requires a few one-time setup steps.

The setup process is supported by a set of helper scripts available from the [Immcantation project](https://immcantation.org/), which can be found in their [GitHub repository](https://github.com/immcantation/immcantation/tree/master/scripts). These scripts simplify the configuration of IgBLAST and IMGT references. You will need the following setup scripts:

- `fetch_igblastdb.sh` — downloads core IgBLAST databases
- `fetch_imgtdb.sh` — downloads IMGT reference sequences
- `clean_imgtdb.py` — cleans downloaded IMGT sequences (optional for some datasets)
- `imgt2igblast.sh` — converts IMGT references to IgBLAST-compatible format

To use these scripts, copy all the tools from the `/scripts` folder in the [Immcantation repository](https://github.com/immcantation/immcantation/tree/master/scripts) into a directory in your `PATH`.

For your convenience, we provide the following script from h [Change-O IgBLAST setup guide](https://changeo.readthedocs.io/en/stable/examples/igblast.html) that automates the download, extraction, and configuration of IgBLAST (adjust version number if needed):

```bash
#!/bin/bash

# Set the IgBLAST version
VERSION="1.22.0"

# Determine the operating system
OS_TYPE=$(uname -s)
ARCH_TYPE=$(uname -m)

# Set download URL based on OS
case "$OS_TYPE" in
    Linux)
        if [ "$ARCH_TYPE" = "x86_64" ]; then
            FILE="ncbi-igblast-${VERSION}-x64-linux.tar.gz"
        else
            echo "Unsupported architecture: $ARCH_TYPE"
            exit 1
        fi
        ;;
    Darwin)
        if [ "$ARCH_TYPE" = "x86_64" ]; then
            FILE="ncbi-igblast-${VERSION}-x64-macosx.tar.gz"
        else
            echo "Unsupported architecture: $ARCH_TYPE"
            exit 1
        fi
        ;;
    *)
        echo "Unsupported OS: $OS_TYPE"
        exit 1
        ;;
esac

# Download and extract IgBLAST
wget "https://ftp.ncbi.nlm.nih.gov/blast/executables/igblast/release/${VERSION}/${FILE}"
tar -zxf "${FILE}"

# Copy binaries
mkdir -p ~/bin
cp ncbi-igblast-${VERSION}/bin/* ~/bin

# Download IgBLAST reference databases
mkdir -p ~/share/igblast
fetch_igblastdb.sh -o ~/share/igblast
cp -r ncbi-igblast-${VERSION}/internal_data ~/share/igblast
cp -r ncbi-igblast-${VERSION}/optional_file ~/share/igblast

# Download and convert IMGT reference sequences
mkdir -p ~/share/germlines/imgt
fetch_imgtdb.sh -o ~/share/germlines/imgt
imgt2igblast.sh -i ~/share/germlines/imgt -o ~/share/igblast

# Set IGDATA environment variable
echo 'export IGDATA=~/share/igblast' >> ~/.bashrc
export IGDATA=~/share/igblast

echo "IgBLAST setup completed successfully."
```

For more details and troubleshooting, refer to the official [Change-O IgBLAST setup guide](https://changeo.readthedocs.io/en/stable/examples/igblast.html).



## License

Licensed under the Apache License. See the [LICENSE](LICENSE) file for details.
