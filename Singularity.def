Bootstrap: docker
From: ubuntu:20.04

%files
    /home/mojtaba/Sys_admin/GATHER/environment.yml /opt/environment.yml
    /home/mojtaba/Sys_admin/GATHER/setup.py /opt/myproject/setup.py
    /home/mojtaba/Sys_admin/GATHER/gather /opt/myproject/gather
    /home/mojtaba/Sys_admin/GATHER/database /opt/myproject/database
    /home/mojtaba/Sys_admin/immcantation/scripts /opt/immcantation_scripts
    /home/mojtaba/Sys_admin/GATHER/README.md /opt/myproject/README.md

%post
    export DEBIAN_FRONTEND=noninteractive
    ln -fs /usr/share/zoneinfo/Etc/UTC /etc/localtime

    # Update system and install dependencies
    apt-get update && apt-get install -y --no-install-recommends \
        wget \
        bzip2 \
        ca-certificates \
        libglib2.0-0 \
        libxext6 \
        libsm6 \
        libxrender1 \
        git \
        libgomp1 \
        tzdata \
        build-essential \
        cmake \
        zlib1g-dev \
        autoconf \
        automake \
        libtool \
        && apt-get clean \
        && rm -rf /var/lib/apt/lists/*

    # Install NCBI BLAST+ 2.16.0
    wget https://ftp.ncbi.nlm.nih.gov/blast/executables/blast+/2.16.0/ncbi-blast-2.16.0+-x64-linux.tar.gz
    tar -xzf ncbi-blast-2.16.0+-x64-linux.tar.gz -C /opt/
    mv /opt/ncbi-blast-2.16.0+ /opt/ncbi-blast
    rm ncbi-blast-2.16.0+-x64-linux.tar.gz

    # Install SPAdes 4.0.0
    wget https://github.com/ablab/spades/releases/download/v4.0.0/SPAdes-4.0.0-Linux.tar.gz
    tar -xzf SPAdes-4.0.0-Linux.tar.gz -C /opt/
    mv /opt/SPAdes-4.0.0-Linux /opt/SPAdes
    rm SPAdes-4.0.0-Linux.tar.gz

    # Install IgBLAST 1.22.0
    IGVER="1.22.0"
    IGBLAST_DIR="/opt/igblast"
    wget https://ftp.ncbi.nlm.nih.gov/blast/executables/igblast/release/${IGVER}/ncbi-igblast-${IGVER}-x64-linux.tar.gz
    tar -xzf ncbi-igblast-${IGVER}-x64-linux.tar.gz
    mv ncbi-igblast-${IGVER} $IGBLAST_DIR
    rm ncbi-igblast-${IGVER}-x64-linux.tar.gz

    # Prepare IgBLAST data directories
    mkdir -p /share/igblast
    mkdir -p /share/germlines/imgt
    cp -r $IGBLAST_DIR/internal_data /share/igblast
    cp -r $IGBLAST_DIR/optional_file /share/igblast

    # Add immcantation scripts to PATH and run helper tools
    export PATH="/opt/ncbi-blast/bin:/opt/immcantation_scripts:$PATH"
    /opt/immcantation_scripts/fetch_igblastdb.sh -o /share/igblast
    /opt/immcantation_scripts/fetch_imgtdb.sh -o /share/germlines/imgt
    /opt/immcantation_scripts/imgt2igblast.sh -i /share/germlines/imgt -o /share/igblast

    # Install IgPhyML from Immcantation
    cd /opt && git clone https://github.com/immcantation/igphyml.git
    cd /opt/igphyml
    chmod +x make_phyml_omp
    ./make_phyml_omp

    # Install Miniconda
    wget -q https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /opt/miniconda.sh
    bash /opt/miniconda.sh -b -p /opt/conda
    rm /opt/miniconda.sh

    # Setup Conda
    /opt/conda/bin/conda config --set always_yes yes --set changeps1 no
    /opt/conda/bin/conda update -q conda -n base

    # Create Conda environment and clean
    /opt/conda/bin/conda env create -f /opt/environment.yml
    /opt/conda/bin/conda clean -a

    # Install gather and Change-O
    /opt/conda/envs/gather_env/bin/pip install -e /opt/myproject
    /opt/conda/envs/gather_env/bin/pip install changeo

    # Install R packages via BiocManager
    /opt/conda/bin/conda run -n gather_env Rscript -e "install.packages('BiocManager', repos='https://cloud.r-project.org')"
    /opt/conda/bin/conda run -n gather_env Rscript -e "BiocManager::install(c('treeio', 'ggtree', 'dowser'), ask=FALSE)"
    /opt/conda/bin/conda run -n gather_env Rscript -e "install.packages(c('dplyr', 'ggrepel'), repos='https://cloud.r-project.org')"

    # Make project scripts executable
    chmod +x /opt/myproject/gather/*.py

    # Make immcantation scripts executable
    chmod +x /opt/immcantation_scripts/*
    ln -s /opt/immcantation_scripts /opt/immcantation

%environment
    export PATH="/opt/myproject/gather:/opt/conda/envs/gather_env/bin:/opt/ncbi-blast/bin:/opt/SPAdes/bin:/opt/igblast/bin:/opt/igphyml/src:/opt/immcantation_scripts:$PATH"
    export PYTHONPATH="/opt/myproject/gather:$PYTHONPATH"
    export IGDATA="/share/igblast"
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8

%labels
    Author "MOJTABA"
    Version "1.0"
    Description "Singularity container with Python, IgBLAST, IMGT, IgPhyML, Change-O, dowser (Bioconductor), and bioinformatics tools"

%runscript
    exec python "$@"

